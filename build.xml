<?xml version="1.0"?>
<Project DefaultTargets="Default" xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="4.0">    
    <UsingTask TaskName="GetAssemblyInformationalVersion" 
        TaskFactory="CodeTaskFactory" 
        AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.v4.0.dll" >
        <ParameterGroup>
            <Assembly ParameterType="System.String" Required="true" />
            <Version ParameterType="System.String" Output="true" />
        </ParameterGroup>
        <Task>
            <Code Type="Fragment" Language="cs">
              var version = System.Diagnostics.FileVersionInfo.GetVersionInfo(Assembly);

              Version = version.ProductVersion;
            </Code>
        </Task>
    </UsingTask>
    <PropertyGroup>
        <Configuration>Release</Configuration>
    </PropertyGroup>

    <Target Name="Default" DependsOnTargets="Test;NugetPack"></Target>

    <Target Name="Build">
        <ItemGroup>
            <Tests Include="src\Cassette.UnitTests\Cassette.UnitTests.csproj"/>
            <Tests Include="src\Cassette.IntegrationTests\Cassette.IntegrationTests.csproj"/>
        </ItemGroup>
        <PropertyGroup>
            <OutputPath>..\..\build\bin</OutputPath>
        </PropertyGroup>

        <!-- Only need to build test projects as dependent projects will be automatically built. -->
        <MSBuild Projects="@(Tests)" Targets="Clean;Build" 
            Properties="Configuration=$(Configuration);TargetFrameworkVersion=v3.5;OutputPath=$(OutputPath)\lib35"/>
        <MSBuild Projects="@(Tests)" Targets="Clean;Build" 
            Properties="Configuration=$(Configuration);TargetFrameworkVersion=v4.0;OutputPath=$(OutputPath)\lib40"/>

    </Target>

    <Target Name="Test" DependsOnTargets="Build">
        <!-- Run tests against 4.0 and 3.5 assemblies; must use CLR4 and 2.0 XUnit otherwise some 3.5 tests will fail -->
        <Exec Command="tools\xunit.console.clr4.x86.exe build\bin\lib40\Cassette.UnitTests.dll" />
        <Exec Command="tools\xunit.console.clr4.x86.exe build\bin\lib40\Cassette.IntegrationTests.dll" />
        <Exec Command="tools\xunit.console.x86.exe build\bin\lib35\Cassette.UnitTests.dll" />
        <Exec Command="tools\xunit.console.x86.exe build\bin\lib35\Cassette.IntegrationTests.dll" />
    </Target>

    <Target Name="NugetPack" DependsOnTargets="Build">
        <ItemGroup>
            <Nuspec Include="src\Cassette\Cassette.nuspec"/>
            <Nuspec Include="src\Cassette.Views\Cassette.Views.nuspec"/>
            <Nuspec Include="src\Cassette.Web\Cassette.Web.nuspec"/>
        </ItemGroup>
        <PropertyGroup>
            <OutputDir>build\nuget</OutputDir>
        </PropertyGroup>
        <GetAssemblyInformationalVersion Assembly="build\bin\lib40\Cassette.dll">
            <Output PropertyName="Version" TaskParameter="Version" />
        </GetAssemblyInformationalVersion>
        <Message Text="Building Nuget packages for v$(Version)" />
        <MakeDir Directories="$(OutputDir)"/>
        <Exec Command="nuget pack %(Nuspec.Identity) -Version $(Version) -Symbols -OutputDirectory $(OutputDir)"/>
        <!-- The Cassette.MSBuild package is slightly different (-Tool, no symbols and -NoPackageAnalysis to avoid warning about DLLs in the Tools directory). -->
        <!-- TODO: This is packaged as a 4.0 package, as it includes the 4.0 DLLs of its dependencies in the Tools folder.
                   If it is an issue for 3.5-based projects, can maybe figure out a clean way to package tools for 3.5 and 4.0.
                   See: src\Cassette.MSBuild\Cassette.MSBuild.nuspec -->
        <Exec Command="nuget pack src\Cassette.MSBuild\Cassette.MSBuild.nuspec -Version $(Version) -Tool -OutputDirectory $(OutputDir) -Prop Configuration=$(Configuration) -NoPackageAnalysis"/>
    </Target>

    <Target Name="NugetPush" DependsOnTargets="NugetPack">
        <ItemGroup>
            <Packages Include="build\nuget\*.nupkg" Exclude="build\nuget\*.symbols.nupkg"/>
        </ItemGroup>
        <Exec Command="nuget push %(Packages.Identity)" />
    </Target>
    
</Project>